<script>
/* globals Temple, Template */
import request from "superagent";

var result = new Temple.Map();
Temple.helpers({ result });
</script>

<template name="body" use="actions">
	<div class="container">
		<h1>{{ title }} <small>the best <b>url shortener</b> in the universe</small></h1>

		<form class="shortform form-inline" on-submit="shorten">
			<input type="text" name="url" class="urlinput form-control" placeholder="URL to shorten" autofocus />
			<button type="submit" class="btn btn-success">Shorten</button>
		</form>

		<p class="result">
			{% if result.get('error') %}
			<i class="text-danger">Oh no!</i><br/> {{ result.get('message') }}
			{% else if result.get('ok') %}
			<i class="text-success">Shortified!</i><br/>
			<b><a href="{{ result.get('shorturl') }}">{{ result.get('shorturl') }}</a></b> &rarr;
			<a href="{{ result.get('original') }}">{{ result.get('original') }}</a><br/>
			<small class="text-muted">(Hint: right-click the link to copy it)</small>
			{% else if result.get('loading') %}
			<div class="spinner">
				<div class="dot1"></div>
				<div class="dot2"></div>
			</div>
			{% endif %}
		</p>

		<footer>
			~{{ urlCount.get() }} urls shortened
			<br/>
			Made with &hearts; and too much caffeine by <a href="https://github.com/tyler-johnson" class="text-success">@tyler-johnson</a>.
			<br/>
			License MIT. <a href="https://github.com/tyler-johnson/shorturl" class="text-success">Source on Github</a>. v{{ version }}
			<br/><br/>
			Have a short URL that needs to be removed?
			<br/>
			Send the URL and a reason for removal to <a href="mailto:tyler@tylerjohnson.me" class="text-success">tyler@tylerjohnson.me</a>.
		</footer>
	</div>
</template>

<script>
Template.body.actions("shorten", function(e) {
	e.original.preventDefault();
	var input = e.target.querySelector("input");
	result.clear().set("loading", true);

	request.get("/").query({ url: input.value }).end(function(err, res) {
		result.clear();

		if (err) {
			var message;
			if (err.status === 400) message = err.response.text;
			else message = "Something terrible happened and we couldn't shorten that link! Please try again.";
			result.set("error", true);
			result.set("message", message);
		} else {
			result.set(res.body).set("ok", true);
			input.value = "";
			input.focus();
		}
	});
});

Temple.paint("body", document.body, {
	title: App.get("site.title") || location.host || App.get("name"),
	version: App.get("version"),
	urlCount: urlCount
});
</script>
